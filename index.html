<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RÃ¨glements Praticiens 2026</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@400;500;600;700;800&family=Instrument+Sans:wght@300;400;500&display=swap');

:root {
  --bg: #f5f3ef;
  --surface: #ffffff;
  --surface2: #f0ede8;
  --border: #e2ddd7;
  --ink: #1a1714;
  --ink2: #5c5650;
  --ink3: #9a948e;
  --gold: #c8922a;
  --gold-light: #f5e6c8;
  --green: #2a7a4b;
  --green-light: #d4edde;
  --red: #c0392b;
  --red-light: #fde8e6;
  --blue: #2563eb;
  --blue-light: #dbeafe;
  --shadow: 0 1px 3px rgba(26,23,20,0.08), 0 4px 16px rgba(26,23,20,0.04);
  --shadow-lg: 0 8px 32px rgba(26,23,20,0.12);
  --radius: 12px;
}

* { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 15px; }

body {
  font-family: 'Instrument Sans', sans-serif;
  background: var(--bg);
  color: var(--ink);
  min-height: 100vh;
}

/* â”€â”€â”€ LAYOUT â”€â”€â”€ */
.app { display: flex; min-height: 100vh; }

.sidebar {
  width: 260px; flex-shrink: 0;
  background: var(--ink);
  display: flex; flex-direction: column;
  position: fixed; top: 0; left: 0; bottom: 0;
  z-index: 200;
}

.sidebar-logo {
  padding: 28px 24px 20px;
  border-bottom: 1px solid rgba(255,255,255,0.08);
}
.sidebar-logo h1 {
  font-family: 'Bricolage Grotesque', sans-serif;
  font-size: 13px; font-weight: 800;
  color: var(--gold); letter-spacing: 1.5px;
  text-transform: uppercase; line-height: 1.4;
}
.sidebar-logo p {
  font-size: 11px; color: rgba(255,255,255,0.35);
  margin-top: 4px;
}

.sidebar-year {
  margin: 16px;
  background: rgba(200,146,42,0.12);
  border: 1px solid rgba(200,146,42,0.25);
  border-radius: 8px; padding: 10px 14px;
  text-align: center;
}
.sidebar-year span {
  font-family: 'Bricolage Grotesque', sans-serif;
  font-size: 28px; font-weight: 800; color: var(--gold);
}

nav { padding: 8px 12px; flex: 1; }
.nav-item {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 12px; border-radius: 8px;
  cursor: pointer; color: rgba(255,255,255,0.5);
  font-size: 13px; font-weight: 500;
  transition: all 0.2s; margin-bottom: 2px;
  border: none; background: none; width: 100%; text-align: left;
}
.nav-item:hover { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.85); }
.nav-item.active { background: rgba(200,146,42,0.15); color: var(--gold); }
.nav-icon { font-size: 15px; width: 18px; text-align: center; }

.sidebar-stats {
  padding: 16px; border-top: 1px solid rgba(255,255,255,0.08);
}
.sidebar-stat { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; }
.sidebar-stat-label { font-size: 11px; color: rgba(255,255,255,0.35); }
.sidebar-stat-val { font-family: 'Bricolage Grotesque', sans-serif; font-size: 13px; font-weight: 700; color: rgba(255,255,255,0.85); }

.main { margin-left: 260px; flex: 1; min-height: 100vh; }

/* â”€â”€â”€ TOPBAR â”€â”€â”€ */
.topbar {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 16px 32px;
  display: flex; align-items: center; justify-content: space-between;
  position: sticky; top: 0; z-index: 100;
  box-shadow: var(--shadow);
}
.topbar-title {
  font-family: 'Bricolage Grotesque', sans-serif;
  font-size: 20px; font-weight: 700; color: var(--ink);
}
.topbar-right { display: flex; gap: 10px; align-items: center; }

/* â”€â”€â”€ BUTTONS â”€â”€â”€ */
.btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 9px 18px; border-radius: 8px;
  font-size: 13px; font-weight: 600;
  cursor: pointer; border: none;
  font-family: 'Instrument Sans', sans-serif;
  transition: all 0.15s;
}
.btn-gold { background: var(--gold); color: #fff; }
.btn-gold:hover { background: #b07d20; }
.btn-outline { background: none; border: 1.5px solid var(--border); color: var(--ink2); }
.btn-outline:hover { border-color: var(--ink2); color: var(--ink); }
.btn-danger { background: var(--red); color: #fff; font-size: 12px; padding: 6px 12px; }
.btn-danger:hover { background: #a93226; }
.btn-sm { padding: 5px 10px; font-size: 12px; }
.btn-green { background: var(--green); color: #fff; }
.btn-green:hover { background: #1e5e38; }

/* â”€â”€â”€ PAGES â”€â”€â”€ */
.page { display: none; padding: 28px 32px; animation: fadeUp 0.25s ease; }
.page.active { display: block; }
@keyframes fadeUp { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

/* â”€â”€â”€ KPI GRID â”€â”€â”€ */
.kpi-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 16px; margin-bottom: 24px; }
.kpi-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px 22px;
  box-shadow: var(--shadow);
  position: relative; overflow: hidden;
}
.kpi-card::after {
  content: ''; position: absolute;
  bottom: 0; left: 0; right: 0; height: 3px;
}
.kpi-card.gold::after { background: var(--gold); }
.kpi-card.green::after { background: var(--green); }
.kpi-card.blue::after { background: var(--blue); }
.kpi-card.red::after { background: var(--red); }

.kpi-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--ink3); margin-bottom: 10px; }
.kpi-value { font-family: 'Bricolage Grotesque', sans-serif; font-size: 24px; font-weight: 800; line-height: 1; margin-bottom: 5px; }
.kpi-card.gold .kpi-value { color: var(--gold); }
.kpi-card.green .kpi-value { color: var(--green); }
.kpi-card.blue .kpi-value { color: var(--blue); }
.kpi-card.red .kpi-value { color: var(--red); }
.kpi-sub { font-size: 12px; color: var(--ink3); }

/* â”€â”€â”€ CARDS â”€â”€â”€ */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow: hidden;
}
.card-header {
  padding: 18px 22px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.card-title {
  font-family: 'Bricolage Grotesque', sans-serif;
  font-size: 15px; font-weight: 700; color: var(--ink);
}
.card-body { padding: 22px; }

/* â”€â”€â”€ GRID LAYOUTS â”€â”€â”€ */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
.grid-3-1 { display: grid; grid-template-columns: 2fr 1.2fr; gap: 20px; margin-bottom: 20px; }

/* â”€â”€â”€ MONTH TABS â”€â”€â”€ */
.month-tabs {
  display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 20px;
}
.month-tab {
  padding: 6px 14px; border-radius: 20px;
  font-size: 12px; font-weight: 600;
  cursor: pointer; transition: all 0.15s;
  border: 1.5px solid var(--border);
  background: var(--surface); color: var(--ink2);
}
.month-tab:hover { border-color: var(--gold); color: var(--gold); }
.month-tab.active { background: var(--gold); border-color: var(--gold); color: #fff; }
.month-tab.has-data { border-color: var(--green); color: var(--green); }
.month-tab.has-data.active { background: var(--green); border-color: var(--green); color: #fff; }

/* â”€â”€â”€ FORM â”€â”€â”€ */
.form-modal-bg {
  display: none; position: fixed; inset: 0;
  background: rgba(26,23,20,0.5); z-index: 500;
  align-items: center; justify-content: center;
  backdrop-filter: blur(4px);
}
.form-modal-bg.open { display: flex; }

.form-modal {
  background: var(--surface);
  border-radius: 16px;
  width: 600px; max-width: 95vw;
  box-shadow: var(--shadow-lg);
  animation: modalIn 0.25s ease;
  max-height: 90vh; overflow-y: auto;
}
@keyframes modalIn { from { opacity:0; transform:scale(0.95) translateY(20px); } to { opacity:1; transform:scale(1) translateY(0); } }

.form-modal-header {
  padding: 22px 26px 18px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.form-modal-title {
  font-family: 'Bricolage Grotesque', sans-serif;
  font-size: 18px; font-weight: 800;
}
.close-btn {
  width: 32px; height: 32px; border-radius: 8px;
  background: var(--surface2); border: none;
  cursor: pointer; font-size: 18px; color: var(--ink2);
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s;
}
.close-btn:hover { background: var(--red-light); color: var(--red); }

.form-body { padding: 22px 26px; }
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
.form-group { display: flex; flex-direction: column; gap: 5px; }
.form-group.full { grid-column: 1/-1; }
.form-label {
  font-size: 11px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.7px;
  color: var(--ink2);
}
.form-input, .form-select {
  padding: 10px 13px; border-radius: 8px;
  border: 1.5px solid var(--border);
  background: var(--bg);
  font-size: 13px; font-family: 'Instrument Sans', sans-serif;
  color: var(--ink); outline: none;
  transition: border-color 0.15s;
}
.form-input:focus, .form-select:focus { border-color: var(--gold); background: #fff; }
.form-input.error { border-color: var(--red); }
.error-msg { font-size: 11px; color: var(--red); margin-top: 2px; }

.form-footer {
  padding: 18px 26px;
  border-top: 1px solid var(--border);
  display: flex; gap: 10px; justify-content: flex-end;
}

/* â”€â”€â”€ CONFIRM MODAL â”€â”€â”€ */
.confirm-modal-bg {
  display: none; position: fixed; inset: 0;
  background: rgba(26,23,20,0.5); z-index: 600;
  align-items: center; justify-content: center;
}
.confirm-modal-bg.open { display: flex; }
.confirm-modal {
  background: var(--surface); border-radius: 12px;
  padding: 28px 32px; width: 380px;
  box-shadow: var(--shadow-lg); text-align: center;
}
.confirm-modal h3 { font-family: 'Bricolage Grotesque', sans-serif; font-size: 17px; margin-bottom: 10px; }
.confirm-modal p { font-size: 13px; color: var(--ink2); margin-bottom: 22px; }
.confirm-btns { display: flex; gap: 10px; justify-content: center; }

/* â”€â”€â”€ TABLE â”€â”€â”€ */
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; }
thead tr { background: var(--surface2); }
thead th {
  padding: 11px 14px; font-size: 11px;
  text-transform: uppercase; letter-spacing: 0.7px;
  color: var(--ink3); font-weight: 600;
  text-align: left; white-space: nowrap;
  cursor: pointer; user-select: none;
  border-bottom: 1px solid var(--border);
}
thead th:hover { color: var(--gold); }
tbody tr { border-bottom: 1px solid var(--border); transition: background 0.12s; }
tbody tr:hover { background: var(--surface2); }
tbody tr:last-child { border-bottom: none; }
td { padding: 11px 14px; font-size: 13px; }

.badge {
  display: inline-flex; align-items: center;
  padding: 3px 9px; border-radius: 20px;
  font-size: 11px; font-weight: 600;
}
.badge-ph { background: var(--blue-light); color: var(--blue); }
.badge-ho { background: var(--red-light); color: var(--red); }
.badge-cl { background: #ede9fe; color: #6d28d9; }
.badge-ca { background: var(--green-light); color: var(--green); }
.badge-de { background: var(--gold-light); color: var(--gold); }
.badge-op { background: #fce7f3; color: #be185d; }
.badge-la { background: #e0f2fe; color: #0369a1; }
.badge-ra { background: #fff7ed; color: #c2410c; }
.badge-au { background: var(--surface2); color: var(--ink3); }

.montant-cell {
  font-family: 'Bricolage Grotesque', sans-serif;
  font-weight: 700; color: var(--green); font-size: 13px;
}

.action-btns { display: flex; gap: 6px; }
.icon-btn {
  width: 28px; height: 28px; border-radius: 6px;
  border: 1.5px solid var(--border); background: var(--surface);
  cursor: pointer; font-size: 13px;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.12s;
}
.icon-btn.edit:hover { border-color: var(--gold); background: var(--gold-light); }
.icon-btn.del:hover { border-color: var(--red); background: var(--red-light); }

/* â”€â”€â”€ PAGINATION â”€â”€â”€ */
.pag {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 20px; border-top: 1px solid var(--border);
  background: var(--surface2);
}
.pag-info { font-size: 12px; color: var(--ink3); }
.pag-btns { display: flex; gap: 5px; }
.pag-btn {
  width: 30px; height: 30px; border-radius: 6px;
  border: 1.5px solid var(--border); background: var(--surface);
  color: var(--ink2); cursor: pointer; font-size: 12px;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.12s;
}
.pag-btn:hover { border-color: var(--gold); color: var(--gold); }
.pag-btn.active { background: var(--gold); border-color: var(--gold); color: #fff; font-weight: 700; }

/* â”€â”€â”€ FILTERS â”€â”€â”€ */
.filters { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 16px; }
.search-input {
  padding: 8px 14px 8px 36px; border-radius: 8px;
  border: 1.5px solid var(--border); background: var(--surface);
  font-size: 13px; outline: none; width: 240px;
  font-family: 'Instrument Sans', sans-serif;
  transition: border-color 0.15s;
}
.search-input:focus { border-color: var(--gold); }
.search-wrap { position: relative; }
.search-wrap::before {
  content: 'ğŸ”'; position: absolute; left: 10px; top: 50%;
  transform: translateY(-50%); font-size: 13px;
}
.filter-select {
  padding: 8px 12px; border-radius: 8px;
  border: 1.5px solid var(--border); background: var(--surface);
  font-size: 13px; font-family: 'Instrument Sans', sans-serif;
  color: var(--ink); outline: none; cursor: pointer;
}
.filter-select:focus { border-color: var(--gold); }

/* â”€â”€â”€ MONTH SUMMARY â”€â”€â”€ */
.month-summary {
  display: flex; gap: 12px; margin-bottom: 16px;
}
.month-stat {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px; padding: 12px 18px;
  flex: 1;
}
.month-stat-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.7px; color: var(--ink3); margin-bottom: 4px; }
.month-stat-val { font-family: 'Bricolage Grotesque', sans-serif; font-size: 18px; font-weight: 800; color: var(--gold); }

/* â”€â”€â”€ EMPTY â”€â”€â”€ */
.empty {
  text-align: center; padding: 50px 20px; color: var(--ink3);
}
.empty-icon { font-size: 40px; margin-bottom: 14px; }
.empty h3 { font-family: 'Bricolage Grotesque', sans-serif; font-size: 16px; color: var(--ink2); margin-bottom: 6px; }
.empty p { font-size: 13px; }

/* â”€â”€â”€ TOAST â”€â”€â”€ */
.toast {
  position: fixed; bottom: 24px; right: 24px;
  background: var(--ink); color: #fff;
  padding: 12px 20px; border-radius: 10px;
  font-size: 13px; font-weight: 500;
  z-index: 999; display: none;
  box-shadow: var(--shadow-lg);
  animation: toastIn 0.3s ease;
  border-left: 4px solid var(--gold);
}
.toast.show { display: block; }
@keyframes toastIn { from { transform: translateX(100%); opacity:0; } to { transform: translateX(0); opacity:1; } }

/* â”€â”€â”€ CHART CARD â”€â”€â”€ */
.chart-card { margin-bottom: 20px; }

/* â”€â”€â”€ BAR STAT â”€â”€â”€ */
.bar-stat { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); }
.bar-stat:last-child { border-bottom: none; }
.bar-name { font-size: 12px; color: var(--ink); min-width: 150px; max-width: 180px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
.bar-track { flex: 1; height: 5px; background: var(--border); border-radius: 3px; overflow: hidden; }
.bar-fill { height: 100%; border-radius: 3px; background: var(--gold); transition: width 0.6s ease; }
.bar-val { font-family: 'Bricolage Grotesque', sans-serif; font-size: 12px; font-weight: 700; color: var(--gold); min-width: 70px; text-align: right; }

/* â”€â”€â”€ LOADING â”€â”€â”€ */
.loading {
  text-align: center; padding: 60px;
  color: var(--ink3); font-size: 14px;
}

@media print {
  .sidebar, .topbar-right, .filters, .action-btns, .pag, .form-modal-bg, .confirm-modal-bg { display: none !important; }
  .main { margin-left: 0; }
  .page { padding: 16px; }
}
</style>
</head>
<body>
<div class="app">

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <h1>RÃ¨glements<br>Praticiens</h1>
    <p>Gestion & Suivi</p>
  </div>
  <div class="sidebar-year"><span>2026</span></div>
  <nav>
    <button class="nav-item active" onclick="nav('dashboard',this)"><span class="nav-icon">ğŸ“Š</span> Dashboard</button>
    <button class="nav-item" onclick="nav('saisie',this)"><span class="nav-icon">âœï¸</span> Saisie rapide</button>
    <button class="nav-item" onclick="nav('reglements',this)"><span class="nav-icon">ğŸ“‹</span> RÃ¨glements</button>
    <button class="nav-item" onclick="nav('categories',this)"><span class="nav-icon">ğŸ¥</span> CatÃ©gories</button>
  </nav>
  <div class="sidebar-stats">
    <div class="sidebar-stat">
      <span class="sidebar-stat-label">Enregistrements</span>
      <span class="sidebar-stat-val" id="sb-count">â€”</span>
    </div>
    <div class="sidebar-stat">
      <span class="sidebar-stat-label">Total 2026</span>
      <span class="sidebar-stat-val" id="sb-total">â€”</span>
    </div>
    <div class="sidebar-stat">
      <span class="sidebar-stat-label">Mois actif</span>
      <span class="sidebar-stat-val" id="sb-month">â€”</span>
    </div>
  </div>
</aside>

<!-- MAIN -->
<div class="main">

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbar-title" id="page-title">Dashboard 2026</div>
    <div class="topbar-right">
      <div style="position:relative;display:inline-block" id="export-menu-wrap">
        <button class="btn btn-outline" onclick="toggleExportMenu()">â¬‡ï¸ Exporter â–¾</button>
        <div id="export-menu" style="display:none;position:absolute;top:110%;right:0;background:#fff;border:1.5px solid var(--border);border-radius:10px;box-shadow:var(--shadow-lg);min-width:210px;z-index:300;overflow:hidden;">
          <div style="padding:6px 0;">
            <button onclick="exportExcel();toggleExportMenu()" style="display:flex;align-items:center;gap:10px;width:100%;padding:10px 16px;border:none;background:none;cursor:pointer;font-size:13px;color:var(--ink);text-align:left;font-family:inherit;" onmouseover="this.style.background='var(--surface2)'" onmouseout="this.style.background='none'">ğŸ“Š <span><strong>Export Excel</strong><br><small style="color:var(--ink3)">.csv pour Excel/Sheets</small></span></button>
            <button onclick="exportCSV();toggleExportMenu()" style="display:flex;align-items:center;gap:10px;width:100%;padding:10px 16px;border:none;background:none;cursor:pointer;font-size:13px;color:var(--ink);text-align:left;font-family:inherit;" onmouseover="this.style.background='var(--surface2)'" onmouseout="this.style.background='none'">ğŸ“‹ <span><strong>Export CSV</strong><br><small style="color:var(--ink3)">Format universel</small></span></button>
            <div style="height:1px;background:var(--border);margin:4px 0"></div>
            <button onclick="exportJSON();toggleExportMenu()" style="display:flex;align-items:center;gap:10px;width:100%;padding:10px 16px;border:none;background:none;cursor:pointer;font-size:13px;color:var(--ink);text-align:left;font-family:inherit;" onmouseover="this.style.background='var(--surface2)'" onmouseout="this.style.background='none'">ğŸ’¾ <span><strong>Backup JSON</strong><br><small style="color:var(--ink3)">Sauvegarde complÃ¨te</small></span></button>
            <button onclick="importJSON();toggleExportMenu()" style="display:flex;align-items:center;gap:10px;width:100%;padding:10px 16px;border:none;background:none;cursor:pointer;font-size:13px;color:var(--green);text-align:left;font-family:inherit;" onmouseover="this.style.background='var(--green-light)'" onmouseout="this.style.background='none'">ğŸ“‚ <span><strong>Restaurer JSON</strong><br><small style="color:var(--ink3)">Importer un backup</small></span></button>
          </div>
        </div>
      </div>
      <button class="btn btn-outline" onclick="window.print()">ğŸ–¨ï¸ Imprimer</button>
      <button class="btn btn-gold" onclick="openForm()">ï¼‹ Nouveau rÃ¨glement</button>
    </div>
  </div>

  <!-- DASHBOARD PAGE -->
  <div class="page active" id="page-dashboard">

    <div class="kpi-grid" id="kpi-grid">
      <div class="kpi-card gold">
        <div class="kpi-label">Total 2026</div>
        <div class="kpi-value" id="kpi-total">0 FCFA</div>
        <div class="kpi-sub" id="kpi-sub-total">Aucun rÃ¨glement</div>
      </div>
      <div class="kpi-card green">
        <div class="kpi-label">Mois en cours</div>
        <div class="kpi-value" id="kpi-month">0 FCFA</div>
        <div class="kpi-sub" id="kpi-sub-month">â€”</div>
      </div>
      <div class="kpi-card blue">
        <div class="kpi-label">Praticiens distincts</div>
        <div class="kpi-value" id="kpi-prat">0</div>
        <div class="kpi-sub" id="kpi-sub-prat">â€”</div>
      </div>
      <div class="kpi-card red">
        <div class="kpi-label">Dernier ajout</div>
        <div class="kpi-value" id="kpi-last">â€”</div>
        <div class="kpi-sub" id="kpi-sub-last">â€”</div>
      </div>
    </div>

    <div class="grid-3-1">
      <div class="card chart-card">
        <div class="card-header">
          <span class="card-title">Ã‰volution mensuelle 2026</span>
        </div>
        <div class="card-body">
          <canvas id="chart-evolution" height="100"></canvas>
        </div>
      </div>
      <div class="card chart-card">
        <div class="card-header">
          <span class="card-title">Par catÃ©gorie</span>
        </div>
        <div class="card-body">
          <canvas id="chart-cat" height="180"></canvas>
        </div>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="card-header"><span class="card-title">Top 8 praticiens</span></div>
        <div class="card-body" id="top-prat-list"></div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">Derniers rÃ¨glements saisis</span></div>
        <div class="card-body" id="recent-list"></div>
      </div>
    </div>

  </div>

  <!-- SAISIE PAGE -->
  <div class="page" id="page-saisie">
    <div style="max-width:640px;">
      <div class="card">
        <div class="card-header">
          <span class="card-title">âœï¸ Nouveau rÃ¨glement</span>
          <span style="font-size:12px;color:var(--ink3)">NumÃ©ro auto-incrÃ©mentÃ©</span>
        </div>
        <div class="card-body">
          <div id="inline-form"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- REGLEMENTS PAGE -->
  <div class="page" id="page-reglements">

    <div class="month-tabs" id="month-tabs"></div>

    <div id="month-summary-bar" class="month-summary"></div>

    <div class="filters">
      <div class="search-wrap">
        <input type="text" class="search-input" id="search-input" placeholder="Rechercher praticien..." oninput="applyFilters()">
      </div>
      <select class="filter-select" id="f-cat" onchange="applyFilters()">
        <option value="">Toutes catÃ©gories</option>
        <option>PHARMACIE</option>
        <option>HOPITAL</option>
        <option>CLINIQUE</option>
        <option>CABINET/PLATEAU MÃ‰DICAL</option>
        <option>DENTISTE</option>
        <option>OPTICIEN</option>
        <option>LABORATOIRE</option>
        <option>RADIOLOGIE</option>
      </select>
      <select class="filter-select" id="f-mode" onchange="applyFilters()">
        <option value="">Tous modes</option>
        <option>VIREMENT</option>
        <option>ESPECES</option>
      </select>
      <button class="btn btn-outline btn-sm" onclick="resetFilters()">âœ• Reset</button>
      <span id="filter-count" style="font-size:12px;color:var(--ink3);margin-left:auto;"></span>
      <button class="btn btn-gold btn-sm" onclick="openForm()">ï¼‹ Ajouter</button>
    </div>

    <div class="card">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th onclick="sortBy('num')">NÂ° â†•</th>
              <th onclick="sortBy('praticien')">Praticien â†•</th>
              <th onclick="sortBy('categorie')">CatÃ©gorie</th>
              <th onclick="sortBy('montant')">Montant â†•</th>
              <th onclick="sortBy('date')">Date â†•</th>
              <th>Mode</th>
              <th>Banque</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="table-body"></tbody>
        </table>
      </div>
      <div class="pag">
        <span class="pag-info" id="pag-info">â€”</span>
        <div class="pag-btns" id="pag-btns"></div>
      </div>
    </div>
  </div>

  <!-- CATEGORIES PAGE -->
  <div class="page" id="page-categories">
    <div class="grid-2">
      <div class="card">
        <div class="card-header"><span class="card-title">Montants par catÃ©gorie</span></div>
        <div class="card-body"><canvas id="chart-cat-bar" height="220"></canvas></div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">Nombre de rÃ¨glements</span></div>
        <div class="card-body"><canvas id="chart-cat-count" height="220"></canvas></div>
      </div>
    </div>
    <div class="card">
      <div class="card-header"><span class="card-title">DÃ©tail par catÃ©gorie</span></div>
      <div class="card-body" id="cat-detail"></div>
    </div>
  </div>

</div><!-- /main -->
</div><!-- /app -->

<!-- FORM MODAL -->
<div class="form-modal-bg" id="form-modal-bg" onclick="if(event.target===this)closeForm()">
  <div class="form-modal">
    <div class="form-modal-header">
      <span class="form-modal-title" id="modal-title">Nouveau rÃ¨glement</span>
      <button class="close-btn" onclick="closeForm()">Ã—</button>
    </div>
    <div class="form-body" id="modal-form-body"></div>
    <div class="form-footer">
      <button class="btn btn-outline" onclick="closeForm()">Annuler</button>
      <button class="btn btn-gold" onclick="saveForm()">ğŸ’¾ Enregistrer</button>
    </div>
  </div>
</div>

<!-- CONFIRM MODAL -->
<div class="confirm-modal-bg" id="confirm-bg">
  <div class="confirm-modal">
    <div style="font-size:36px;margin-bottom:12px">ğŸ—‘ï¸</div>
    <h3>Supprimer ce rÃ¨glement ?</h3>
    <p id="confirm-text">Cette action est irrÃ©versible.</p>
    <div class="confirm-btns">
      <button class="btn btn-outline" onclick="closeConfirm()">Annuler</button>
      <button class="btn btn-danger" onclick="confirmDelete()">Supprimer</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MONTHS_2026 = [
  'JANVIER 2026','FEVRIER 2026','MARS 2026','AVRIL 2026',
  'MAI 2026','JUIN 2026','JUILLET 2026','AOUT 2026',
  'SEPTEMBRE 2026','OCTOBRE 2026','NOVEMBRE 2026','DECEMBRE 2026'
];

const CATS = ['PHARMACIE','HOPITAL','CLINIQUE','CABINET/PLATEAU MÃ‰DICAL','DENTISTE','OPTICIEN','LABORATOIRE','RADIOLOGIE','AUTRE'];
const BANQUES = ['FBN BANK','BNP PARIBAS','CBAO','SUNU BANK','BOA','ECOBANK','UBA','AUTRE'];
const CAT_COLORS = {
  'PHARMACIE':'#2563eb','HOPITAL':'#c0392b','CLINIQUE':'#6d28d9',
  'CABINET/PLATEAU MÃ‰DICAL':'#2a7a4b','DENTISTE':'#c8922a','OPTICIEN':'#be185d',
  'LABORATOIRE':'#0369a1','RADIOLOGIE':'#c2410c','AUTRE':'#9a948e'
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let allData = [];
let filteredData = [];
let activeMonth = MONTHS_2026[new Date().getMonth()] || MONTHS_2026[0];
let sortState = { col: 'num', dir: 1 };
let currentPage = 1;
const PER_PAGE = 20;
let editId = null;
let deleteId = null;
let charts = {};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE CONFIG â€” Base de donnÃ©es partagÃ©e temps rÃ©el
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FIREBASE_URL = 'https://ipm-ridwan-default-rtdb.europe-west1.firebasedatabase.app';
const DB_PATH = '/reglements2026';

async function loadData() {
  try {
    showLoadingIndicator(true);
    const res = await fetch(FIREBASE_URL + DB_PATH + '.json');
    const data = await res.json();
    allData = data ? Object.values(data) : [];
    // Stocker les Firebase keys pour les updates/deletes
    if (data) {
      window._fbKeys = {};
      Object.entries(data).forEach(([k,v]) => { window._fbKeys[v.id] = k; });
    } else {
      window._fbKeys = {};
    }
  } catch(e) {
    console.error('Firebase load error:', e);
    // Fallback localStorage
    try { allData = JSON.parse(localStorage.getItem('reglements-2026-data') || '[]'); } catch(_) { allData = []; }
    showToast('âš ï¸ Connexion Firebase impossible â€” mode local activÃ©');
  }
  showLoadingIndicator(false);
  renderAll();
}

async function saveData() {
  try {
    // Sauvegarder chaque item avec son ID Firebase
    const payload = {};
    allData.forEach(d => {
      const fbKey = (window._fbKeys && window._fbKeys[d.id]) || d.id;
      payload[fbKey] = d;
      if (!window._fbKeys) window._fbKeys = {};
      window._fbKeys[d.id] = fbKey;
    });
    await fetch(FIREBASE_URL + DB_PATH + '.json', {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
    // Backup localStorage aussi
    localStorage.setItem('reglements-2026-data', JSON.stringify(allData));
  } catch(e) {
    // Fallback localStorage
    localStorage.setItem('reglements-2026-data', JSON.stringify(allData));
    showToast('âš ï¸ Sauvegarde locale uniquement');
  }
}

function showLoadingIndicator(show) {
  let el = document.getElementById('fb-loading');
  if (!el) {
    el = document.createElement('div');
    el.id = 'fb-loading';
    el.style.cssText = 'position:fixed;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#c8922a,#f5e6c8,#c8922a);background-size:200%;animation:fbload 1s infinite;z-index:9999;display:none;';
    document.head.insertAdjacentHTML('beforeend','<style>@keyframes fbload{0%{background-position:0%}100%{background-position:200%}}</style>');
    document.body.appendChild(el);
  }
  el.style.display = show ? 'block' : 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT EXCEL (via CSV bien formatÃ© pour Excel)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportExcel() {
  // CrÃ©e un vrai fichier Excel-compatible avec mise en forme
  const rows = [
    ['NÂ°','Mois','Praticien','CatÃ©gorie','Montant (FCFA)','Date','Mode de rÃ¨glement','Banque','Commentaire']
  ];
  allData.forEach(d => rows.push([
    d.num||'', d.month, d.praticien, normCat(d.categorie),
    d.montant, d.date||'', d.reglement||'', d.banque||'', d.commentaire||''
  ]));
  // SÃ©parateur point-virgule pour Excel franÃ§ais
  const csv = rows.map(r => r.map(c => '"'+String(c).replace(/"/g,'""')+'"').join(';')).join('\r\n');
  const blob = new Blob(['\uFEFF'+csv], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `reglements_praticiens_2026_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  showToast('âœ… Export Excel prÃªt ! Ouvrez avec Excel.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BACKUP JSON (sauvegarde complÃ¨te)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportJSON() {
  const backup = {
    version: '1.0',
    date: new Date().toISOString(),
    count: allData.length,
    data: allData
  };
  const blob = new Blob([JSON.stringify(backup, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `backup_reglements_2026_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  showToast('âœ… Backup JSON tÃ©lÃ©chargÃ© !');
}

function importJSON() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      try {
        const backup = JSON.parse(ev.target.result);
        const imported = backup.data || backup;
        if (!Array.isArray(imported)) throw new Error('Format invalide');
        if (confirm(`Importer ${imported.length} rÃ¨glement(s) ?\n\nCela REMPLACERA toutes vos donnÃ©es actuelles (${allData.length} rÃ¨glements).`)) {
          allData = imported;
          saveData();
          renderAll();
          showToast(`âœ… ${imported.length} rÃ¨glements importÃ©s !`);
        }
      } catch(err) {
        alert('âŒ Fichier invalide : ' + err.message);
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

function nextNum(month) {
  const monthData = allData.filter(d => d.month === month);
  if (monthData.length === 0) return 1;
  return Math.max(...monthData.map(d => d.num || 0)) + 1;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function nav(page, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  if (btn) btn.classList.add('active');
  const titles = { dashboard:'Dashboard 2026', saisie:'Saisie rapide', reglements:'RÃ¨glements', categories:'Analyse par CatÃ©gorie' };
  document.getElementById('page-title').textContent = titles[page];
  if (page === 'dashboard') renderDashboard();
  if (page === 'saisie') renderInlineForm();
  if (page === 'reglements') { renderMonthTabs(); applyFilters(); }
  if (page === 'categories') renderCategories();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmt(n) {
  if (!n && n !== 0) return 'â€”';
  return new Intl.NumberFormat('fr-FR').format(Math.round(n)) + ' FCFA';
}
function fmtShort(n) {
  if (!n) return '0';
  if (n >= 1_000_000) return (n/1_000_000).toFixed(1) + 'M';
  if (n >= 1_000) return (n/1_000).toFixed(0) + 'k';
  return n.toString();
}
function normCat(cat) {
  if (!cat) return 'AUTRE';
  const c = cat.toUpperCase().trim();
  if (c.includes('PHARMACIE')) return 'PHARMACIE';
  if (c.includes('HOPITAL') || c.includes('CHR') || c.includes('CHN') || c.includes('CHU') || c.includes('CS ') || c.includes('CENTRE') || c.includes('DISTRICT') || c.includes('POSTE') || c.includes('SAMU') || c.includes('EPS')) return 'HOPITAL';
  if (c.includes('CLINIQUE') || c.includes('POLYCLIN')) return 'CLINIQUE';
  if (c.includes('CABINET') || c.includes('PLATEAU')) return 'CABINET/PLATEAU MÃ‰DICAL';
  if (c.includes('DENTISTE')) return 'DENTISTE';
  if (c.includes('OPTICIEN')) return 'OPTICIEN';
  if (c.includes('LABORATOIRE') || c.includes('LABO')) return 'LABORATOIRE';
  if (c.includes('RADIOLOGIE')) return 'RADIOLOGIE';
  return cat;
}
function badgeClass(cat) {
  const c = normCat(cat);
  const map = { 'PHARMACIE':'ph','HOPITAL':'ho','CLINIQUE':'cl','CABINET/PLATEAU MÃ‰DICAL':'ca','DENTISTE':'de','OPTICIEN':'op','LABORATOIRE':'la','RADIOLOGIE':'ra' };
  return 'badge badge-' + (map[c] || 'au');
}
function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2); }
function currentMonthName() {
  const mois = ['JANVIER','FEVRIER','MARS','AVRIL','MAI','JUIN','JUILLET','AOUT','SEPTEMBRE','OCTOBRE','NOVEMBRE','DECEMBRE'];
  return mois[new Date().getMonth()] + ' 2026';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll() {
  updateSidebar();
  if (document.getElementById('page-dashboard').classList.contains('active')) renderDashboard();
  if (document.getElementById('page-reglements').classList.contains('active')) { renderMonthTabs(); applyFilters(); }
  if (document.getElementById('page-categories').classList.contains('active')) renderCategories();
}

function updateSidebar() {
  document.getElementById('sb-count').textContent = allData.length;
  const total = allData.reduce((s,d) => s + (d.montant||0), 0);
  document.getElementById('sb-total').textContent = fmtShort(total) + ' FCFA';
  const cm = currentMonthName();
  const monthData = allData.filter(d => d.month === cm);
  document.getElementById('sb-month').textContent = monthData.length ? fmtShort(monthData.reduce((s,d)=>s+d.montant,0)) : '0';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard() {
  const total = allData.reduce((s,d) => s + (d.montant||0), 0);
  const cm = currentMonthName();
  const monthData = allData.filter(d => d.month === cm);
  const monthTotal = monthData.reduce((s,d) => s + (d.montant||0), 0);
  const uniquePrat = new Set(allData.map(d => d.praticien)).size;
  const last = allData.slice().sort((a,b) => (b.createdAt||0) - (a.createdAt||0))[0];

  document.getElementById('kpi-total').textContent = fmtShort(total) + ' FCFA';
  document.getElementById('kpi-sub-total').textContent = `${allData.length} rÃ¨glement${allData.length>1?'s':''}`;
  document.getElementById('kpi-month').textContent = fmtShort(monthTotal) + ' FCFA';
  document.getElementById('kpi-sub-month').textContent = cm + ' â€” ' + monthData.length + ' rÃ©gl.';
  document.getElementById('kpi-prat').textContent = uniquePrat;
  document.getElementById('kpi-sub-prat').textContent = `${new Set(allData.map(d=>d.month)).size} mois avec donnÃ©es`;
  document.getElementById('kpi-last').textContent = last ? last.praticien.substring(0,15)+'â€¦' : 'â€”';
  document.getElementById('kpi-sub-last').textContent = last ? fmt(last.montant) : 'Aucun rÃ¨glement';

  // Chart evolution
  const monthTotals = MONTHS_2026.map(m => allData.filter(d=>d.month===m).reduce((s,d)=>s+d.montant,0));
  const labels = MONTHS_2026.map(m => m.split(' ')[0].substring(0,4));
  if (charts.evo) charts.evo.destroy();
  charts.evo = new Chart(document.getElementById('chart-evolution'), {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        data: monthTotals,
        backgroundColor: monthTotals.map(v => v > 0 ? '#c8922a' : '#e2ddd7'),
        borderRadius: 6, borderSkipped: false
      }]
    },
    options: {
      responsive: true,
      plugins: { legend:{display:false}, tooltip:{callbacks:{label:ctx=>fmt(ctx.raw)}} },
      scales: {
        x:{grid:{display:false}, ticks:{color:'#9a948e',font:{size:10}}},
        y:{grid:{color:'#f0ede8'}, ticks:{color:'#9a948e',callback:v=>fmtShort(v)}}
      }
    }
  });

  // Chart cat donut
  const catMap = {};
  allData.forEach(d => { const c=normCat(d.categorie); catMap[c]=(catMap[c]||0)+d.montant; });
  const catE = Object.entries(catMap).sort((a,b)=>b[1]-a[1]);
  if (charts.cat) charts.cat.destroy();
  if (catE.length === 0) {
    document.getElementById('chart-cat').parentElement.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“Š</div><p>Aucune donnÃ©e</p></div>';
  } else {
    charts.cat = new Chart(document.getElementById('chart-cat'), {
      type: 'doughnut',
      data: {
        labels: catE.map(e=>e[0]),
        datasets: [{ data: catE.map(e=>e[1]), backgroundColor: catE.map(e=>CAT_COLORS[e[0]]||'#9a948e'), borderWidth: 0 }]
      },
      options: { responsive:true, cutout:'60%', plugins:{legend:{position:'bottom',labels:{color:'#5c5650',font:{size:10},padding:8}}, tooltip:{callbacks:{label:ctx=>ctx.label+': '+fmt(ctx.raw)}}} }
    });
  }

  // Top praticiens
  const pMap = {};
  allData.forEach(d => pMap[d.praticien]=(pMap[d.praticien]||0)+d.montant);
  const top8 = Object.entries(pMap).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const maxV = top8[0]?.[1] || 1;
  document.getElementById('top-prat-list').innerHTML = top8.length ? top8.map(([n,v]) => `
    <div class="bar-stat">
      <span class="bar-name" title="${n}">${n}</span>
      <div class="bar-track"><div class="bar-fill" style="width:${(v/maxV*100).toFixed(1)}%"></div></div>
      <span class="bar-val">${fmtShort(v)}</span>
    </div>`).join('') : '<div class="empty"><p>Aucune donnÃ©e</p></div>';

  // Recent
  const recent = allData.slice().sort((a,b)=>(b.createdAt||0)-(a.createdAt||0)).slice(0,6);
  document.getElementById('recent-list').innerHTML = recent.length ? recent.map(d => `
    <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);">
      <div>
        <div style="font-size:12px;font-weight:600;color:var(--ink)">${d.praticien.substring(0,30)}${d.praticien.length>30?'â€¦':''}</div>
        <div style="font-size:11px;color:var(--ink3)">${d.month} Â· ${d.date||'â€”'}</div>
      </div>
      <span style="font-family:Bricolage Grotesque,sans-serif;font-size:13px;font-weight:700;color:var(--green)">${fmtShort(d.montant)}</span>
    </div>`).join('') : '<div class="empty"><p>Aucune donnÃ©e</p></div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORM (modal + inline)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function formHTML(data = {}, isInline = false) {
  const month = data.month || currentMonthName();
  const monthOptions = MONTHS_2026.map(m => `<option value="${m}" ${m===month?'selected':''}>${m}</option>`).join('');
  const catOptions = CATS.map(c => `<option value="${c}" ${c===(data.categorie||'')?'selected':''}>${c}</option>`).join('');
  const bankOptions = BANQUES.map(b => `<option value="${b}" ${b===(data.banque||'FBN BANK')?'selected':''}>${b}</option>`).join('');

  return `
    <div class="form-grid" id="${isInline?'il':'fm'}-grid">
      <div class="form-group">
        <label class="form-label">Mois *</label>
        <select class="form-select" id="${isInline?'il':'fm'}-month">${monthOptions}</select>
      </div>
      <div class="form-group">
        <label class="form-label">Date de paiement *</label>
        <input type="date" class="form-input" id="${isInline?'il':'fm'}-date" value="${data.date||new Date().toISOString().slice(0,10)}">
      </div>
      <div class="form-group full">
        <label class="form-label">Praticien *</label>
        <input type="text" class="form-input" id="${isInline?'il':'fm'}-praticien" placeholder="Nom du praticien / Ã©tablissement" value="${data.praticien||''}" list="${isInline?'il':'fm'}-prat-list">
        <datalist id="${isInline?'il':'fm'}-prat-list">${[...new Set(allData.map(d=>d.praticien))].map(p=>`<option value="${p}">`).join('')}</datalist>
        <span class="error-msg" id="${isInline?'il':'fm'}-err-praticien"></span>
      </div>
      <div class="form-group">
        <label class="form-label">CatÃ©gorie *</label>
        <select class="form-select" id="${isInline?'il':'fm'}-categorie"><option value="">-- Choisir --</option>${catOptions}</select>
        <span class="error-msg" id="${isInline?'il':'fm'}-err-categorie"></span>
      </div>
      <div class="form-group">
        <label class="form-label">Montant (FCFA) *</label>
        <input type="number" class="form-input" id="${isInline?'il':'fm'}-montant" placeholder="ex: 1500000" value="${data.montant||''}" min="1">
        <span class="error-msg" id="${isInline?'il':'fm'}-err-montant"></span>
      </div>
      <div class="form-group">
        <label class="form-label">Mode de rÃ¨glement</label>
        <select class="form-select" id="${isInline?'il':'fm'}-mode">
          <option value="VIREMENT" ${(data.reglement||'VIREMENT')==='VIREMENT'?'selected':''}>Virement</option>
          <option value="ESPECES" ${data.reglement==='ESPECES'?'selected':''}>EspÃ¨ces</option>
          <option value="CHEQUE" ${data.reglement==='CHEQUE'?'selected':''}>ChÃ¨que</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Banque</label>
        <select class="form-select" id="${isInline?'il':'fm'}-banque">${bankOptions}</select>
      </div>
      <div class="form-group full">
        <label class="form-label">Commentaire</label>
        <input type="text" class="form-input" id="${isInline?'il':'fm'}-comment" placeholder="Optionnel..." value="${data.commentaire||''}">
      </div>
    </div>`;
}

function collectForm(prefix) {
  return {
    month: document.getElementById(prefix+'-month').value,
    date: document.getElementById(prefix+'-date').value,
    praticien: document.getElementById(prefix+'-praticien').value.trim().toUpperCase(),
    categorie: document.getElementById(prefix+'-categorie').value,
    montant: parseFloat(document.getElementById(prefix+'-montant').value),
    reglement: document.getElementById(prefix+'-mode').value,
    banque: document.getElementById(prefix+'-banque').value,
    commentaire: document.getElementById(prefix+'-comment').value.trim(),
  };
}

function validateForm(d, prefix) {
  let ok = true;
  const clear = id => { const el = document.getElementById(prefix+'-err-'+id); if(el) { el.textContent=''; } const inp = document.getElementById(prefix+'-'+id); if(inp) inp.classList.remove('error'); };
  const err = (id, msg) => { ok=false; const el = document.getElementById(prefix+'-err-'+id); if(el) el.textContent=msg; const inp = document.getElementById(prefix+'-'+id); if(inp) inp.classList.add('error'); };
  ['praticien','categorie','montant'].forEach(clear);
  if (!d.praticien) err('praticien','Ce champ est obligatoire');
  if (!d.categorie) err('categorie','Choisissez une catÃ©gorie');
  if (!d.montant || d.montant <= 0 || isNaN(d.montant)) err('montant','Montant invalide');
  return ok;
}

// Modal form
function openForm(id = null) {
  editId = id;
  const existing = id ? allData.find(d=>d.id===id) : null;
  document.getElementById('modal-title').textContent = id ? 'âœï¸ Modifier le rÃ¨glement' : 'ï¼‹ Nouveau rÃ¨glement';
  document.getElementById('modal-form-body').innerHTML = formHTML(existing || {}, false);
  document.getElementById('form-modal-bg').classList.add('open');
}
function closeForm() {
  document.getElementById('form-modal-bg').classList.remove('open');
  editId = null;
}
function saveForm() {
  const d = collectForm('fm');
  if (!validateForm(d,'fm')) return;
  if (editId) {
    const idx = allData.findIndex(x=>x.id===editId);
    if (idx > -1) { allData[idx] = { ...allData[idx], ...d }; }
    showToast('âœ… RÃ¨glement modifiÃ© !');
  } else {
    d.id = uid();
    d.num = nextNum(d.month);
    d.createdAt = Date.now();
    allData.push(d);
    showToast('âœ… RÃ¨glement enregistrÃ© â€” NÂ°' + d.num);
  }
  saveData();
  renderAll();
  closeForm();
}

// Inline form (saisie page)
function renderInlineForm() {
  document.getElementById('inline-form').innerHTML = formHTML({}, true) + `
    <div style="display:flex;gap:10px;margin-top:20px;padding-top:16px;border-top:1px solid var(--border);">
      <button class="btn btn-gold" onclick="saveInlineForm()" style="flex:1">ğŸ’¾ Enregistrer le rÃ¨glement</button>
      <button class="btn btn-outline" onclick="resetInlineForm()">âœ• RÃ©initialiser</button>
    </div>
    <div id="il-success" style="display:none;margin-top:14px;background:var(--green-light);border:1px solid var(--green);border-radius:8px;padding:12px 16px;font-size:13px;color:var(--green);font-weight:600;"></div>`;
}
function saveInlineForm() {
  const d = collectForm('il');
  if (!validateForm(d,'il')) return;
  d.id = uid();
  d.num = nextNum(d.month);
  d.createdAt = Date.now();
  allData.push(d);
  saveData();
  renderAll();
  const succ = document.getElementById('il-success');
  succ.style.display = 'block';
  succ.innerHTML = `âœ… RÃ¨glement NÂ°${d.num} enregistrÃ© â€” <strong>${d.praticien}</strong> â€” ${fmt(d.montant)}`;
  setTimeout(() => { succ.style.display='none'; resetInlineForm(); }, 3000);
}
function resetInlineForm() { renderInlineForm(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DELETE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function askDelete(id) {
  deleteId = id;
  const d = allData.find(x=>x.id===id);
  document.getElementById('confirm-text').textContent = `Supprimer le rÃ¨glement de ${d?.praticien||''} (${fmt(d?.montant||0)}) ?`;
  document.getElementById('confirm-bg').classList.add('open');
}
function closeConfirm() { document.getElementById('confirm-bg').classList.remove('open'); deleteId=null; }
function confirmDelete() {
  if (!deleteId) return;
  allData = allData.filter(d=>d.id!==deleteId);
  saveData(); renderAll();
  closeConfirm();
  showToast('ğŸ—‘ï¸ RÃ¨glement supprimÃ©');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABLE & FILTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMonthTabs() {
  const tabs = document.getElementById('month-tabs');
  tabs.innerHTML = MONTHS_2026.map(m => {
    const hasData = allData.some(d=>d.month===m);
    return `<div class="month-tab ${m===activeMonth?'active':''} ${hasData&&m!==activeMonth?'has-data':''}" onclick="setActiveMonth('${m}')">${m.split(' ')[0].substring(0,4)}</div>`;
  }).join('');
}

function setActiveMonth(m) {
  activeMonth = m;
  renderMonthTabs();
  applyFilters();
}

function applyFilters() {
  const search = (document.getElementById('search-input')?.value || '').toLowerCase();
  const cat = document.getElementById('f-cat')?.value || '';
  const mode = document.getElementById('f-mode')?.value || '';

  let base = allData.filter(d => d.month === activeMonth);
  if (search) base = base.filter(d => d.praticien.toLowerCase().includes(search));
  if (cat) base = base.filter(d => normCat(d.categorie) === cat);
  if (mode) base = base.filter(d => (d.reglement||'').toUpperCase().includes(mode));

  base.sort((a,b) => {
    let va = a[sortState.col], vb = b[sortState.col];
    if (typeof va === 'string') va = va.toLowerCase();
    if (typeof vb === 'string') vb = vb.toLowerCase();
    return sortState.dir * (va > vb ? 1 : va < vb ? -1 : 0);
  });

  filteredData = base;
  currentPage = 1;
  document.getElementById('filter-count').textContent = `${filteredData.length} rÃ©sultat${filteredData.length>1?'s':''}`;

  // Month summary
  const mTotal = allData.filter(d=>d.month===activeMonth).reduce((s,d)=>s+d.montant,0);
  const mCount = allData.filter(d=>d.month===activeMonth).length;
  document.getElementById('month-summary-bar').innerHTML = `
    <div class="month-stat"><div class="month-stat-label">Total ${activeMonth}</div><div class="month-stat-val">${fmtShort(mTotal)} FCFA</div></div>
    <div class="month-stat"><div class="month-stat-label">RÃ¨glements</div><div class="month-stat-val">${mCount}</div></div>
    <div class="month-stat"><div class="month-stat-label">Praticiens</div><div class="month-stat-val">${new Set(allData.filter(d=>d.month===activeMonth).map(d=>d.praticien)).size}</div></div>
    <div class="month-stat"><div class="month-stat-label">Moy. par rÃ¨glement</div><div class="month-stat-val">${mCount?fmtShort(Math.round(mTotal/mCount)):0} FCFA</div></div>`;

  renderTable();
}

function sortBy(col) {
  if (sortState.col === col) sortState.dir *= -1;
  else { sortState.col = col; sortState.dir = 1; }
  applyFilters();
}
function resetFilters() {
  document.getElementById('search-input').value = '';
  document.getElementById('f-cat').value = '';
  document.getElementById('f-mode').value = '';
  applyFilters();
}

function renderTable() {
  const start = (currentPage-1)*PER_PAGE;
  const slice = filteredData.slice(start, start+PER_PAGE);
  const tbody = document.getElementById('table-body');

  if (slice.length === 0) {
    tbody.innerHTML = `<tr><td colspan="8"><div class="empty"><div class="empty-icon">ğŸ“‹</div><h3>${allData.filter(d=>d.month===activeMonth).length===0?'Aucun rÃ¨glement ce mois':'Aucun rÃ©sultat'}</h3><p>${allData.filter(d=>d.month===activeMonth).length===0?'Cliquez sur Â« Ajouter Â» pour saisir le premier rÃ¨glement.':'Modifiez vos filtres.'}</p></div></td></tr>`;
  } else {
    tbody.innerHTML = slice.map(d => `
      <tr>
        <td style="font-weight:700;color:var(--ink3)">${d.num||'â€”'}</td>
        <td style="max-width:180px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;" title="${d.praticien}"><strong>${d.praticien}</strong></td>
        <td><span class="${badgeClass(d.categorie)}">${normCat(d.categorie)}</span></td>
        <td class="montant-cell">${fmt(d.montant)}</td>
        <td>${d.date||'â€”'}</td>
        <td><span style="font-size:12px;color:var(--ink2)">${d.reglement||'â€”'}</span></td>
        <td style="font-size:12px;color:var(--ink3)">${d.banque||'â€”'}</td>
        <td><div class="action-btns">
          <button class="icon-btn edit" onclick="openForm('${d.id}')" title="Modifier">âœï¸</button>
          <button class="icon-btn del" onclick="askDelete('${d.id}')" title="Supprimer">ğŸ—‘ï¸</button>
        </div></td>
      </tr>`).join('');
  }

  const total = filteredData.length;
  const pages = Math.ceil(total/PER_PAGE);
  document.getElementById('pag-info').textContent = `${start+1}â€“${Math.min(start+PER_PAGE,total)} sur ${total}`;
  const btns = document.getElementById('pag-btns');
  btns.innerHTML = '';
  for (let p=1; p<=Math.min(pages,7); p++) {
    const b = document.createElement('button');
    b.className = 'pag-btn' + (p===currentPage?' active':'');
    b.textContent = p;
    b.onclick = () => { currentPage=p; renderTable(); };
    btns.appendChild(b);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CATEGORIES PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCategories() {
  const catMap = {}, catCount = {};
  allData.forEach(d => {
    const c = normCat(d.categorie);
    catMap[c] = (catMap[c]||0) + d.montant;
    catCount[c] = (catCount[c]||0) + 1;
  });
  const sorted = Object.entries(catMap).sort((a,b)=>b[1]-a[1]);
  const labels = sorted.map(e=>e[0]);
  const totals = sorted.map(e=>e[1]);
  const counts = labels.map(l=>catCount[l]);
  const colors = labels.map(l=>CAT_COLORS[l]||'#9a948e');

  if (charts.catBar) charts.catBar.destroy();
  if (totals.length) {
    charts.catBar = new Chart(document.getElementById('chart-cat-bar'), {
      type:'bar',
      data:{ labels, datasets:[{ data:totals, backgroundColor:colors, borderRadius:6 }] },
      options:{ indexAxis:'y', responsive:true, plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>fmt(ctx.raw)}}}, scales:{ x:{grid:{color:'#f0ede8'},ticks:{color:'#9a948e',callback:v=>fmtShort(v)}}, y:{grid:{display:false},ticks:{color:'#5c5650'}} } }
    });
  }

  if (charts.catCount) charts.catCount.destroy();
  if (counts.length) {
    charts.catCount = new Chart(document.getElementById('chart-cat-count'), {
      type:'bar',
      data:{ labels, datasets:[{ data:counts, backgroundColor:colors.map(c=>c+'55'), borderColor:colors, borderWidth:1, borderRadius:6 }] },
      options:{ indexAxis:'y', responsive:true, plugins:{legend:{display:false}}, scales:{ x:{grid:{color:'#f0ede8'},ticks:{color:'#9a948e'}}, y:{grid:{display:false},ticks:{color:'#5c5650'}} } }
    });
  }

  const maxT = totals[0]||1;
  document.getElementById('cat-detail').innerHTML = sorted.length ? sorted.map(([n,v],i) => `
    <div class="bar-stat">
      <span class="bar-name" style="min-width:200px">${n}</span>
      <div class="bar-track"><div class="bar-fill" style="width:${(v/maxT*100).toFixed(1)}%;background:${colors[i]}"></div></div>
      <span class="bar-val" style="color:${colors[i]}">${fmt(v)}</span>
      <span style="font-size:11px;color:var(--ink3);margin-left:10px">${catCount[n]} rÃ©gl.</span>
    </div>`).join('')
    : '<div class="empty"><p>Aucune donnÃ©e pour le moment.</p></div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV() {
  const rows = [['NÂ°','Mois','Praticien','CatÃ©gorie','Montant','Date','Mode','Banque','Commentaire']];
  allData.forEach(d => rows.push([d.num||'',d.month,d.praticien,normCat(d.categorie),d.montant,d.date||'',d.reglement||'',d.banque||'',d.commentaire||'']));
  const csv = rows.map(r => r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,\uFEFF' + encodeURIComponent(csv);
  a.download = 'reglements_praticiens_2026.csv';
  a.click();
  showToast('âœ… Export CSV prÃªt');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT MENU TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleExportMenu() {
  const menu = document.getElementById('export-menu');
  menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}
document.addEventListener('click', e => {
  const wrap = document.getElementById('export-menu-wrap');
  if (wrap && !wrap.contains(e.target)) {
    const menu = document.getElementById('export-menu');
    if (menu) menu.style.display = 'none';
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
loadData();
</script>
</body>
</html>
